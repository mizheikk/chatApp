var chatApp = angular.module('chatApp', ['ngRoute','chatAppControllers','chatAppServices']);

chatApp.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/chat/:user', {
        templateUrl: 'chat.html'
      }).
      otherwise({
        templateUrl: 'login.html'
      });
  }]);

var chatAppControllers = angular.module('chatAppControllers', []);

chatAppControllers.controller('loginController', function($route, $scope, $location) {
  $scope.addUser = function() {
      var username = $scope.newUsername;
      $scope.newUsername = 'joo';
      console.log($location.url());
      $location.url("chat/"+username);
      //$location.url("chat.html?user="+username);
  }
});

chatAppControllers.controller('setMessageController', function($routeParams, $scope, FirebaseService) {

  var username = $routeParams.user;

  $scope.addMessage = function() {
    FirebaseService.addMessage(username,$scope.newMessage);
    $scope.newMessage = '';
  }
});

chatAppControllers.controller('getMessagesController', function($scope, FirebaseService) {
  var messages = FirebaseService.getMessages();
  $scope.messages = messages;
});

var chatAppServices = angular.module('chatAppServices', ['firebase']);

chatAppServices.service('FirebaseService', function($firebaseObject, $firebaseArray) {
  var ref = new Firebase('https://luminous-torch-1910.firebaseio.com/');
  var usersRef = ref.child("users");
  var messagesRef = ref.child("messages");
  var messages = $firebaseArray(messagesRef);

  var data = $firebaseObject(ref);

  this.addUser = function(name) {
    usersRef.once("value", function(snapshot) {
      if ( snapshot.child(name).exists() == false) {
        usersRef.child(name).set('');
      }
    });
  }

  this.getMessages = function() {
    return messages;
  }

  this.addMessage = function(name,msg) {
    var newMessage = messagesRef.push();
    newMessage.set({
      author:name,
      message:msg
    });
  }
});
